#!/usr/bin/env bash
# Install Playwright browsers in Heroku
echo "Installing Playwright browsers..."
python -m playwright install chromium

# Create symlink from Playwright Chrome to system Chromium
echo "Creating symlink to system Chromium..."
PLAYWRIGHT_CHROME_PATH="/app/.cache/ms-playwright/chromium-1181/chrome-linux/chrome"
SYSTEM_CHROMIUM="/usr/bin/chromium-browser"
SNAP_CHROMIUM="/snap/bin/chromium"

# Find system Chrome/Chromium
if [ -f "$SYSTEM_CHROMIUM" ]; then
    echo "Using system chromium-browser at $SYSTEM_CHROMIUM"
    CHROME_EXEC="$SYSTEM_CHROMIUM"
elif [ -f "$SNAP_CHROMIUM" ]; then
    echo "Using snap chromium at $SNAP_CHROMIUM"
    CHROME_EXEC="$SNAP_CHROMIUM"
else
    echo "No system Chrome found, using default"
    CHROME_EXEC=""
fi

# Create symlink if we have a system Chrome
if [ -n "$CHROME_EXEC" ] && [ ! -f "$PLAYWRIGHT_CHROME_PATH" ]; then
    echo "Creating symlink: $PLAYWRIGHT_CHROME_PATH -> $CHROME_EXEC"
    mkdir -p "$(dirname "$PLAYWRIGHT_CHROME_PATH")"
    ln -sf "$CHROME_EXEC" "$PLAYWRIGHT_CHROME_PATH"
    echo "Symlink created successfully"
fi

echo "Playwright setup completed successfully!"